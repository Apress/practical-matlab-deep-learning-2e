
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>DANCERGUI Interactive tool for dancer data acquisition.</title><meta name="generator" content="MATLAB 9.12"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-10-04"><meta name="DC.source" content="DancerGUI.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>DANCERGUI Interactive tool for dancer data acquisition.</h1><!--introduction--><p>The input file must be of type .obj.</p><p>Type DancerGUI for a demo.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Form:</a></li><li><a href="#2">Inputs</a></li><li><a href="#3">Outputs</a></li><li><a href="#4">Copyright</a></li></ul></div><h2 id="1">Form:</h2><pre class="language-matlab">DancerGUI;        <span class="comment">% demo of Ballerina.obj</span>
DancerGUI( file )
</pre><h2 id="2">Inputs</h2><pre class="language-matlab">file  (1,:) File <span class="string">name</span> <span class="string">-</span> <span class="string">needs</span> <span class="string">to</span> <span class="string">be</span> <span class="string">a</span> <span class="string">complete</span> <span class="string">path</span> <span class="string">name</span>
</pre><h2 id="3">Outputs</h2><pre class="language-matlab">Saves <span class="string">to</span> <span class="string">a</span> <span class="string">MAT</span> <span class="string">file</span>
</pre><h2 id="4">Copyright</h2><pre class="language-matlab">Copyright (c) 2019 Princeton <span class="string">Satellite</span> <span class="string">Systems</span>, Inc.
All <span class="string">rights</span> <span class="string">reserved.</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% DANCERGUI Interactive tool for dancer data acquisition.
% The input file must be of type .obj.
%
% Type DancerGUI for a demo.
%
%% Form:
%   DancerGUI;        % demo of Ballerina.obj
%   DancerGUI( file )
%
%% Inputs
%   file  (1,:) File name - needs to be a complete path name
%
%% Outputs
%   Saves to a MAT file
%

function DancerGUI( file )

% Demo
if( nargin < 1 )
  DancerGUI('Ballerina.obj');
  return
end

% Storage of data need by the deep learning system
kStore      = 1;
accelStore  = zeros(3,1000);
gyroStore   = zeros(3,1000);
quatStore   = zeros(4,1000);
timeStore   = zeros(1,1000);
time        = 0;
on3D        = false;
quitNow     = false;

sZ = get(0,'ScreenSize') + [99 99 -200 -200];

h.fig = figure('name','Dancer Data Acquisition','position',sZ,...
  'units','pixels','NumberTitle','off','tag','DancerGUI',...
  'color',[0.9 0.9 0.9]);

% Plot display
gPlot.yLabel = {'\omega_x' '\omega_y' '\omega_z' 'a_x' 'a_y' 'a_z'};
gPlot.tLabel = 'Time (sec)';
gPlot.tLim   = [0 100];
gPlot.pos    = [0.45    0.88    0.46    0.1];
gPlot.color  = 'b';
gPlot.width  = 1;

% Calibration
q0         = [1;0;0;0];
a0         = [0;0;0];

dIMU.accel = a0;
dIMU.quat  = q0;

% Initialize the GUI
DrawGUI;

% Get bluetooth information
instrreset; % Just in case the IMU wasn't close properly
btInfo  = instrhwinfo('Bluetooth');

if( ~isempty(btInfo.RemoteIDs) )
  % Display the information about the first device discovered
  btInfo.RemoteNames(1)
  btInfo.RemoteIDs(1)
  for iB = length(btInfo.RemoteIDs)
    if( strcmp(btInfo.RemoteNames(iB),'LPMSB2-4B31D6') )
      break;
    end
  end
  b = Bluetooth(btInfo.RemoteIDs{iB}, 1);
  fopen(b); % No output allowed for some reason
  noIMU = false;
  a     = fread(b,91);
  dIMU  = DataFromIMU( a );
else
  warndlg('The IMU is not available.', 'Hardware Configuration')
  noIMU   = true;
end

% Wait for user input
uiwait;
% The run loop
time = 0;
tic
while(1)
  if( noIMU )
    omegaZ = 2*pi;
    dT     = toc;
    time   = time + dT;
    tic
    a      = omegaZ*time;
    q      = [cos(a);0;0;sin(a)];
    accel  = [0;0;sin(a)];
    omega  = [0;0;omegaZ];
  else
    % Query the bluetooth device
    a = fread(b,91);
    pause(0.1); % needed so not to overload the bluetooth device

    dT   = toc;
    time = time + dT;
    tic

    % Get a data structure
    if( length(a) > 1 )
      dIMU = DataFromIMU( a );
    end
    accel  = dIMU.accel - a0;
    omega  = dIMU.gyro;
    q      = QuaternionMultiplication(q0,dIMU.quat);

    timeStore(1,kStore)  = time;
    accelStore(:,kStore) = accel;
    gyroStore(:,kStore)  = omega;
    quatStore(:,kStore)  = q;
    kStore = kStore + 1;
  end

  if( quitNow )
    close( h.fig )
    return
  else
    if( on3D )
      QuaternionVisualization( 'update', q );
    end
    set(h.text(1),'string',sprintf('[%5.2f;%5.2f;%5.2f] m/s^2',accel));
    set(h.text(2),'string',sprintf('[%5.2f;%5.2f;%5.2f] rad/s',omega));
    set(h.text(3),'string',datestr(now));
    gPlot = GUIPlots( 'update', [omega;accel], time, gPlot );
  end
end

  function DrawGUI
  % Create the GUI

  % Plots
  gPlot = GUIPlots( 'initialize', [], [], gPlot );

  % Quaternion display
  subplot('position',[0.05 0.5 0.4 0.4],'DataAspectRatio',[1 1 1],...
          'PlotBoxAspectRatio',[1 1 1] );
  QuaternionVisualization( 'initialize', file, h.fig );

  % Buttons
  f   = {'Acceleration', 'Angular Rates' 'Time'};
  n   = length(f);
  p   = get(h.fig,'position');
  dY  = p(4)/20;
  yH  = p(4)/21;
  y   = 0.5;
  x   = 0.15;
  wX  = p(3)/6;

  % Create pushbuttons and defaults
  for k = 1:n
    h.pushbutton(k) = uicontrol( h.fig,'style','text','string',f{k},...
                                 'position',[x y wX yH]);
    h.text(k) = uicontrol( h.fig,'style','text','string','',...
                           'position',[x+wX y 2*wX yH]);
    y = y + dY;
  end

  h.onButton = uicontrol( h.fig,'style','togglebutton',...
    'string','Start/Stop','position',[x y wX yH],'ForegroundColor','red',...
    'callback',@StartStop);
  y = y + dY;
  h.clrButton = uicontrol( h.fig,'style','pushbutton',...
    'string','Clear Data','position',[x y wX yH],'callback',@Clear);
  y = y + dY;
  h.quitButton = uicontrol( h.fig,'style','pushbutton',...
    'string','Quit','position',[x y wX yH],'callback',@Quit);
  y = y + dY;
  h.calibrateButton = uicontrol( h.fig,'style','pushbutton',...
    'string','Calibrate','position',[x y wX yH],'callback',@Calibrate);
  y = y + dY;
  h.saveButton = uicontrol( h.fig,'style','pushbutton','string','Save',...
    'position',[x y wX yH],'callback',@SaveFile);   y = y + dY;
  h.on3D = uicontrol( h.fig,'style','togglebutton','string','3D on/off',...
    'position',[x y wX yH],'ForegroundColor','red','callback',@On3D);

  h.matFile = uicontrol( h.fig,'style','edit', 'string','MyDancer',...
    'position',[x+wX y wX yH]);

  % 3D on/off button callback
    function On3D(~, ~, ~ )
      on3D = ~on3D;
    end

  % Start/Stop button callback
    function StartStop(hObject, ~, ~ )
      if( hObject.Value )
        uiresume;
      else
        SaveFile;
        uiwait
      end
    end

  % Quit button callback
    function Quit(~, ~, ~ )
      button = questdlg('Save Data?','Exit Dialog','Yes','No','No');
      switch button
        case 'Yes'
          % Save data
        case 'No'
      end
      quitNow = true;
      uiresume
    end

  % Clear button callback
    function Clear(~, ~, ~ )
      kStore      = 1;
      accelStore  = zeros(3,1000);
      gyroStore   = zeros(3,1000);
      quatStore   = zeros(4,1000);
      timeStore   = zeros(1,1000);
      time        = 0;
    end

  % Calibrate button callback
    function Calibrate(~, ~, ~ )
      a       = fread(b,91);
      dIMU    = DataFromIMU( a );
      a0      = dIMU.accel;
      q0      = dIMU.quat;
      QuaternionVisualization( 'update', q0 )
    end

  % Save button call back
    function SaveFile(~,~,~)
      cd TestData
      fileName = get(h.matFile,'string');
      s = dir;
      n = length(s);
      fNames = cell(1,n-2);
      for kF = 3:n
        fNames{kF-2} = s(kF).name(1:end-4);
      end
      j = contains(fNames,fileName);
      m = 0;
      if( ~isempty(j) )
        for kF = 1:length(j)
          if( j(kF))
            f = fNames{kF};
            i = strfind(f,'_');
            m = str2double(f(i+1:end));
          end
        end
      end

      timeStore(kStore:end) = [];
      gyroStore(:,kStore:end) = [];
      quatStore(:,kStore:end) = [];
      accelStore(:,kStore:end) = [];

      state = [gyroStore;accelStore;quatStore];
      time  = timeStore;

      save(sprintf('%s_%d.mat',fileName,m+1), 'state','time');

      kStore      = 1;
      accelStore  = zeros(3,1000);
      gyroStore   = zeros(3,1000);
      quatStore   = zeros(4,1000);
      timeStore   = zeros(1,1000);
      time        = 0;

      cd ..

      gPlot = GUIPlots( 'initialize', [], [], gPlot );

    end

  end

end

%% Copyright
%   Copyright (c) 2019 Princeton Satellite Systems, Inc.
%   All rights reserved.

##### SOURCE END #####
--></body></html>